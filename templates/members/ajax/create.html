<html>
    <head></head>
    <body>
        <h1>Add Member</h1>
        <form id="myForm" method ="POST" action="">      
             {% csrf_token %}
            <table>
                <tr>
                    <td>Name</td>
                    <td> <input type="text" name="name" id="name" placeholder="Name"></td>
                </tr>
                <tr>
                    <td>Age</td>
                    <td>  <input type="number" name="age" id="age" placeholder="Age"></td>
                </tr>
                <tr>
                    <td>City</td>
                    <td> <input type="text" name="city" id="city" placeholder="City"></td>
                </tr>
                <tr>
                    <td> <input type="submit" id="submit" value="Create"></td>
                </tr>
            </table>
        </form>

        <table border="1" id="membersTable">
    <thead>
        <tr>
            <th>Name</th>
            <th>Age</th>
            <th>City</th>
        </tr>
    </thead>
    <tbody id="membersBody">
        <!-- Data yahan inject hoga -->
    </tbody>
</table>
    </body>
</html>

<script>
     let isEditable = false;
     let editingId = null;
    document.getElementById("myForm").addEventListener("submit", function(event) {
        event.preventDefault(); // Prevent the default form submission
        const formData = new FormData(this);

        console.log(formData.get('name'));
        if(isEditable){

            fetch(`/members/ajax_update/${editingId}/`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                console.log(data);
                getlist();
            })
            .catch(error => {
                console.error('Error:', error);
            });

        }else{
            alert("Create")
            fetch('', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                console.log(data);
                getlist();
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }
    });

    function getlist() {
        fetch('/members/getlist')
        .then(response => response.json())
        .then(data => {
            console.log(data);
            let tbody = document.getElementById('membersBody');
            tbody.innerHTML = ""; // Clear old data

            // Loop through members list
            data.members.forEach(member => {
                let row = `<tr>
                    <td>${member.name}</td>
                    <td>${member.age}</td>
                    <td>${member.city}</td>
                    <td><button onclick="deleteMember(${member.id})">Del</button></td>
                    <td><button onclick="editMember(${member.id})">Edt</button></td>
                </tr>`;
                tbody.innerHTML += row;
            });
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }

    getlist()

    function deleteMember(id){
            fetch(`/members/ajax_delete/${id}`)
            .then(response => response.json())
            .then(data => {
                console.log(data);
                getlist();
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }

    
       
    function editMember(id){
        fetch(`/members/ajax_edit/${id}`)
        .then(response => response.json())
        .then(data => {
            console.log(data);
           document.getElementById('name').value = data.members.name;
           document.getElementById('age').value = data.members.age;
           document.getElementById('city').value = data.members.city;
           document.getElementById('submit').value = "Update";
           document.getElementById('myForm').id = "newForm";
           document.getElementById('submit').onclick = function() {
               update(data.members.id);
            };
            isEditable = true;
            editingId= data.members.id;
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }

    function update(id){
       const newForm = document.getElementById("newForm");
       const formData = new FormData(newForm);
       console.log(formData.get('name'));
    }
</script>